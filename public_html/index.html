<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link
            rel="stylesheet"
            href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
            integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
            crossorigin="anonymous"
            />
        <link rel="stylesheet" href="css/style.css" />
    </head>

    <body id="all">
        <!--Imagenes-->
        <img src="img/empty.png" id="empty" style="display: none;" />
        <img src="img/paret.png" id="paret" style="display: none;" />
        <img
            src="img/piezaAmarilla.png"
            id="piezaAmarilla"
            style="display: none;"
            />
        <img src="img/piezaAzul.png" id="piezaAzul" style="display: none;" />
        <img src="img/piezaLila.png" id="piezaLila" style="display: none;" />
        <img src="img/piezaMorada.png" id="piezaMorada" style="display: none;" />
        <img src="img/piezaNaranja.png" id="piezaNaranja" style="display: none;" />
        <img src="img/piezaRoja.png" id="piezaRoja" style="display: none;" />
        <img src="img/piezaVerde.png" id="piezaVerde" style="display: none;" />

        <div class="agrupador">
            <div id="joc"></div>
            <canvas id="espai" width="240" height="600"> </canvas>
            <canvas id="seguent" width="120" height="120"></canvas>
        </div>
        <script>
            var Pieza = function (formaYColor, x, y) {
                this.forma = formaYColor[0];
                this.color = formaYColor[1];
                this.x = x;
                this.y = y;
            };
            function GeneraPecaAleatoria() {
                var peces = [
                    [[[0, 0, 0, 0], [0, 1, 1, 0], [0, 1, 1, 0], [0, 0, 0, 0]], "groc"],
                    [[[0, 1, 0, 0], [0, 1, 0, 0], [0, 1, 0, 0], [0, 1, 0, 0]], "lila"],
                    [[[0, 0, 0, 0], [0, 1, 1, 0], [1, 1, 0, 0], [0, 0, 0, 0]], "verd"],
                    [[[0, 0, 0, 0], [0, 1, 1, 0], [0, 0, 1, 1], [0, 0, 0, 0]], "roig"],
                    [[[0, 1, 0, 0], [0, 1, 0, 0], [0, 1, 1, 0], [0, 0, 0, 0]], "blau"],
                    [[[0, 1, 1, 0], [0, 1, 0, 0], [0, 1, 0, 0], [0, 0, 0, 0]], "taronga"],
                    [[[0, 0, 0, 0], [1, 1, 1, 0], [0, 1, 0, 0], [0, 0, 0, 0]], "morat"]
                ];
                var numeroAleatori = Math.round(Math.random() * 6);
                return peces[numeroAleatori];
            }
            Pieza.prototype.moureEsquerra = function () {
                this.x--;
            };
            Pieza.prototype.moureDreta = function () {
                if (this.x + 1 < 11) {
                    this.x++;
                }
            };

            Pieza.prototype.moureAbaix = function () {
                this.y++;
            };

            Pieza.prototype.rotarDreta = function () {
                var formaNova = new Array();
                for (var i = 0; i < this.forma.length; i++) {
                    formaNova[i] = new Array();
                    for (var j = 0; j < this.forma[i].length; j++) {
                        formaNova[i][j] = this.forma[this.forma[i].length - 1 - j][i];
                    }
                }
                this.forma = formaNova;
            };
            Pieza.prototype.rotarEsquerra = function () {
                this.rotarDreta();
                this.rotarDreta();
                this.rotarDreta();
            };
            Pieza.prototype.pintar = function () {
                var canvas = document.getElementById("seguent");
                var ctx = canvas.getContext("2d");
                var img;
                for (var i = 0; i < this.forma.length; i++) {
                    for (var j = 0; j < this.forma[i].length; j++) {
                        if (this.forma[i][j] === 1) {
                            switch (this.color) {
                                case "groc":
                                    img = document.getElementById("piezaAmarilla");
                                    break;
                                case "blau":
                                    img = document.getElementById("piezaAzul");
                                    break;
                                case "lila":
                                    img = document.getElementById("piezaLila");
                                    break;
                                case "morat":
                                    img = document.getElementById("piezaMorada");
                                    break;
                                case "taronga":
                                    img = document.getElementById("piezaNaranja");
                                    break;
                                case "roig":
                                    img = document.getElementById("piezaRoja");
                                    break;
                                case "verd":
                                    img = document.getElementById("piezaVerde");
                                    break;
                            }
                        } else {
                            img = document.getElementById("empty");
                        }
                        ctx.drawImage(img, j * 30, i * 30, 30, 30);
                    }
                }
            };
            Pieza.prototype.getForma = function () {
                return this.forma;
            };
            Pieza.prototype.mirarUltimaFilaForma = function () {
                for (var i = 0; i < 4; i++) {
                    if (this.forma[3][i] == 1) {
                        return 3;
                    }
                }
                for (var i = 0; i < 4; i++) {
                    if (this.forma[2][i] == 1) {
                        return 2;
                    }
                }
                return 1;
            };
            Pieza.prototype.mirarLimiteIzquierdo = function () {
                for (var i = 0; i < 4; i++) {
                    if (this.forma[i][0] === 1) {
                        return 0;
                    }
                }
                for (var i = 0; i < 4; i++) {
                    if (this.forma[i][1] === 1) {
                        return 1;
                    }
                }
                return 2;
            };
            Pieza.prototype.mirarLimiteDerecho = function () {
                for (var i = 0; i < 4; i++) {
                    if (this.forma[i][3] === 1) {
                        return 3;
                    }
                }
                for (var i = 0; i < 4; i++) {
                    if (this.forma[i][2] === 1) {
                        return 2;
                    }
                }
                return 1;
            };
            var Joc = {
                espai: 0,
                espaiBackUp: 0,
                estat: 0,
                puntuacio: 0,
                puntuacioMax: 0,
                pecaVigent: new Pieza(GeneraPecaAleatoria(), 3, 0),
                seguentPeca: new Pieza(GeneraPecaAleatoria(), 3, 0),
                nombreDeVegades: new Array(),
                interval: 500,
                nivell: 0,
                teclat: document.getElementById("all"),
                inicialitzarJoc: function () {
                    this.espai = [
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                    ];
                    this.nombreDeVegades["i"] = 0;
                    this.nombreDeVegades["j"] = 0;
                    this.nombreDeVegades["l"] = 0;
                    this.nombreDeVegades["o"] = 0;
                    this.nombreDeVegades["s"] = 0;
                    this.nombreDeVegades["t"] = 0;
                    this.nombreDeVegades["z"] = 0;
                    this.nivell = 1;

                    var este = this;
                    este.teclat = este.teclat.addEventListener(
                            "keydown",
                            este.teclatUsuari
                            );

                    setInterval(function () {
                        este.movimiento();
                    }, este.interval);
                },
                teclatUsuari: function (e) {
                    var este = Joc;
                    if (e.keyCode === 40) {
                        //abajo
                        este.pecaVigent.moureAbaix();
                    } else if (e.keyCode === 38) {
                        //arriba
                        este.pecaVigent.rotarEsquerra();
                    } else if (e.keyCode === 37) {
                        //esquerra
                        if (este.pecaVigent.mirarLimiteIzquierdo() + este.pecaVigent.x > 0) {
                            este.pecaVigent.moureEsquerra();
                        }

                    } else if (e.keyCode === 39) {
                        //dreta 
                        console.log(este.pecaVigent.x + este.pecaVigent.mirarLimiteDerecho());
                        if (este.pecaVigent.mirarLimiteDerecho() + este.pecaVigent.x < 9) {
                            este.pecaVigent.moureDreta();
                        }

                    }
                },
                seHaSalido: function () {
                    var cont = 0;
                    for (var i = 0; i < this.espai.length; i++) {
                        for (var j = 0; j < this.espai[i].length; j++) {
                            if (this.espai[i][j]) {
                                cont++;
                            }
                        }
                    }
                    return cont;
                },
                haColapsat: function () {
                    var bool = false;
                    for (var i = 0; i < this.espai.length; i++) {
                        for (var j = 0; j < this.espai[i].length; j++) {
                            if (this.espai[i][j] === "P") {
                                if (this.espaiBackUp[i][j] === 1) {
                                    bool = true;
                                }
                            }
                        }
                    }
                    return bool;
                },
                intervalJoc: function () {},
                posicionSiguienteHayPieza: function () {
                    for (var i = 0; i < this.pecaVigent.forma.length; i++) {
                        for (var j = 0; j < this.pecaVigent.forma[i].length; j++) {
                            if (
                                    this.espai[this.pecaVigent.y + i][this.pecaVigent.x + j] === 1
                                    ) {
                                return true;
                            }
                        }
                        return false;
                    }
                },
                cambiarPieza: function () {
                    this.pecaVigent = this.seguentPeca;
                    this.pecaVigent.x = 3;
                    this.pecaVigent.y = 0;
                    this.seguentPeca = new Pieza(GeneraPecaAleatoria(), 3, 0);

                    this.vaciarEspacio(1);
                },
                movimiento: function () {

                    try {
                        if (this.colocarPiezaATauler() === false) {
                            throw e;
                        }
                    } catch (e) {
                        this.vaciarEspacio(0);
                        this.pecaVigent.y--;
                        this.colocarPiezaATauler();
                        error = true;
                        this.cambiarPieza();
                        this.pinta();
                    }
                    this.pecaVigent.y++;
                    this.pinta();
                    this.vaciarEspacio(0);
                },
                vaciarEspacio: function (parametro) {
                    for (var i = 0; i < this.espai.length; i++) {
                        for (var j = 0; j < this.espai[i].length; j++) {
                            if (this.espai[i][j] === "P") {
                                this.espai[i][j] = parametro;
                            }
                        }
                    }
                },
                pinta: function () {
                    var canvas = document.getElementById("espai");
                    var ctx = canvas.getContext("2d");
                    var img;
                    var print;

                    print = "Nivell: " + this.nivell + "<br>";
                    print += "Puntuació Actual: " + this.puntuacioMax + "<br>";
                    print += "Puntuació Màxima: " + this.puntuacioMax;
                    document.getElementById("joc").innerHTML = print;

                    this.seguentPeca.pintar();

                    for (var i = 0; i < this.espai.length; i++) {
                        for (var j = 0; j < this.espai[i].length; j++) {
                            if (this.espai[i][j] === "P") {
                                switch (this.pecaVigent.color) {
                                    case "groc":
                                        img = document.getElementById("piezaAmarilla");
                                        break;
                                    case "blau":
                                        img = document.getElementById("piezaAzul");
                                        break;
                                    case "lila":
                                        img = document.getElementById("piezaLila");
                                        break;
                                    case "morat":
                                        img = document.getElementById("piezaMorada");
                                        break;
                                    case "taronga":
                                        img = document.getElementById("piezaNaranja");
                                        break;
                                    case "roig":
                                        img = document.getElementById("piezaRoja");
                                        break;
                                    case "verd":
                                        img = document.getElementById("piezaVerde");
                                        break;
                                }
                            } else if (this.espai[i][j] === 1) {
                                img = document.getElementById("paret");
                            } else {
                                img = document.getElementById("empty");
                            }
                            ctx.drawImage(img, j * 24, i * 24, 24, 24);
                        }
                    }
                },
                colocarPiezaATauler: function () {
                    this.espaiBackUp = this.espai;
                    var top = 0;
                    var trobat = false;
                    for (var i = 0; i < this.pecaVigent.forma.length; i++) {
                        for (var j = 0; j < this.pecaVigent.forma[i].length; j++) {
                            if (this.pecaVigent.forma[i][j] === 1) {
                                console.log("error: " + parseInt(this.pecaVigent.y + top));
                                if (this.pecaVigent.y + top < 25 || this.pecaVigent.x + j >= 0) {
                                    if (this.espai[this.pecaVigent.y + top][this.pecaVigent.x + j] !==0) {
                                        return false;
                                    }
                                    if (this.espai[this.pecaVigent.y + top][this.pecaVigent.x + j] == 1) {
                                        return false;
                                    } else {
                                        this.espai[this.pecaVigent.y + top][this.pecaVigent.x + j] ="P";
                                        trobat = true;
                                    }
                                } else {
                                    return false;
                                }
                            }
                        }
                        if (trobat === true) {
                            top++;
                        }
                    }
                    return true;
                }
            };

            Joc.inicialitzarJoc();
        </script>
    </body>
</html>
