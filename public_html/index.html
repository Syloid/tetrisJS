<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link
            rel="stylesheet"
            href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
            integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
            crossorigin="anonymous"
            />
        <link rel="stylesheet" href="css/style.css" />
    </head>

    <body id="all">
        <!--Imagenes-->
        <img src="img/empty.png" id="empty" style="display: none;" />
        <img src="img/paret.png" id="paret" style="display: none;" />
        <img
            src="img/piezaAmarilla.png"
            id="piezaAmarilla"
            style="display: none;"
            />
        <img src="img/piezaAzul.png" id="piezaAzul" style="display: none;" />
        <img src="img/piezaLila.png" id="piezaLila" style="display: none;" />
        <img src="img/piezaMorada.png" id="piezaMorada" style="display: none;" />
        <img src="img/piezaNaranja.png" id="piezaNaranja" style="display: none;" />
        <img src="img/piezaRoja.png" id="piezaRoja" style="display: none;" />
        <img src="img/piezaVerde.png" id="piezaVerde" style="display: none;" />

        <div class="agrupador">
            <div id="joc"></div>
            <canvas id="espai" width="240" height="600"> </canvas>
            <canvas id="seguent" width="120" height="120"></canvas>
        </div>
        <script>
            var Pieza = function (formaYColor, x, y) {
                this.forma = formaYColor[0];
                this.color = formaYColor[1];
                this.x = x;
                this.y = y;
            };
            function GeneraPecaAleatoria() {
                var peces = [
                    [[[0, 0, 0, 0], [0, 1, 1, 0], [0, 1, 1, 0], [0, 0, 0, 0]], "groc"],
                    [[[0, 1, 0, 0], [0, 1, 0, 0], [0, 1, 0, 0], [0, 1, 0, 0]], "lila"],
                    [[[0, 0, 0, 0], [0, 1, 1, 0], [1, 1, 0, 0], [0, 0, 0, 0]], "verd"],
                    [[[0, 0, 0, 0], [0, 1, 1, 0], [0, 0, 1, 1], [0, 0, 0, 0]], "roig"],
                    [[[0, 1, 0, 0], [0, 1, 0, 0], [0, 1, 1, 0], [0, 0, 0, 0]], "blau"],
                    [[[0, 1, 1, 0], [0, 1, 0, 0], [0, 1, 0, 0], [0, 0, 0, 0]], "taronga"],
                    [[[0, 0, 0, 0], [1, 1, 1, 0], [0, 1, 0, 0], [0, 0, 0, 0]], "morat"]
                ];
                var numeroAleatori = Math.round(Math.random() * 6);
                return peces[numeroAleatori];
            }
            Pieza.prototype.moureEsquerra = function () {
                this.x--;
            };
            Pieza.prototype.moureDreta = function () {
                if (this.x + 1 < 11) {
                    this.x++;
                }
            };

            Pieza.prototype.moureAbaix = function () {
                this.y++;
            };

            Pieza.prototype.rotarDreta = function () {
                var formaNova = new Array();
                for (var i = 0; i < this.forma.length; i++) {
                    formaNova[i] = new Array();
                    for (var j = 0; j < this.forma[i].length; j++) {
                        formaNova[i][j] = this.forma[this.forma[i].length - 1 - j][i];
                    }
                }
                this.forma = formaNova;
            };
            Pieza.prototype.rotarEsquerra = function () {
                var formaNova = new Array();
                for (var i = this.forma.length-1; i >=0; i--) {
                    formaNova[i] = new Array();
                    for (var j = this.forma[i].length-1; j >=0; j--) {
                        formaNova[i][j] = this.forma[j][this.forma[i].length - 1 - i];
                    }
                }
                this.forma = formaNova;
            };
            Pieza.prototype.pintar = function () {
                var canvas = document.getElementById("seguent");
                var ctx = canvas.getContext("2d");
                var img;
                for (var i = 0; i < this.forma.length; i++) {
                    for (var j = 0; j < this.forma[i].length; j++) {
                        if (this.forma[i][j] === 1) {
                            switch (this.color) {
                                case "groc":
                                    img = document.getElementById("piezaAmarilla");
                                    break;
                                case "blau":
                                    img = document.getElementById("piezaAzul");
                                    break;
                                case "lila":
                                    img = document.getElementById("piezaLila");
                                    break;
                                case "morat":
                                    img = document.getElementById("piezaMorada");
                                    break;
                                case "taronga":
                                    img = document.getElementById("piezaNaranja");
                                    break;
                                case "roig":
                                    img = document.getElementById("piezaRoja");
                                    break;
                                case "verd":
                                    img = document.getElementById("piezaVerde");
                                    break;
                            }
                        } else {
                            img = document.getElementById("empty");
                        }
                        ctx.drawImage(img, j * 30, i * 30, 30, 30);
                    }
                }
            };
            Pieza.prototype.getForma = function () {
                return this.forma;
            };
            Pieza.prototype.mirarLimiteIzquierdo = function () {
                for (var i = 0; i < 4; i++) {
                    if (this.forma[i][0] === 1) {
                        return 0;
                    }
                }
                for (var i = 0; i < 4; i++) {
                    if (this.forma[i][1] === 1) {
                        return 1;
                    }
                }
                return 2;
            };
            Pieza.prototype.mirarLimiteDerecho = function () {
                for (var i = 0; i < 4; i++) {
                    if (this.forma[i][3] === 1) {
                        return 3;
                    }
                }
                for (var i = 0; i < 4; i++) {
                    if (this.forma[i][2] === 1) {
                        return 2;
                    }
                }
                return 1;
            };
            var Joc = {
                espai: 0,
                espaiBackUp: 0,
                estat: 0,
                puntuacio: 0,
                puntuacioMax: 0,
                pecaVigent: new Pieza(GeneraPecaAleatoria(), 3, 0),
                seguentPeca: new Pieza(GeneraPecaAleatoria(), 3, 0),
                nombreDeVegades: new Array(),
                interval: 1000,
                nivell: 0,
                teclat: null,
                inicialitzarJoc: function () {
                    this.espai = [
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                    ];
                    this.nombreDeVegades["i"] = 0;
                    this.nombreDeVegades["j"] = 0;
                    this.nombreDeVegades["l"] = 0;
                    this.nombreDeVegades["o"] = 0;
                    this.nombreDeVegades["s"] = 0;
                    this.nombreDeVegades["t"] = 0;
                    this.nombreDeVegades["z"] = 0;
                    this.teclat = document.getElementById("all");
                    this.nivell = 1;
                    this.puntuacio = 0;

                    if(document.cookie.indexOf('puntuacioMax=')<0) {
                        document.cookie = "puntuacioMax="+parseInt(0);
                    }else {
                        var valorDeLaCookie = parseInt(document.cookie.substring(document.cookie.indexOf("=")+1));
                        this.puntuacioMax=valorDeLaCookie;
                    }
                    var este = Joc;
                    este.teclat = este.teclat.addEventListener(
                            "keydown",
                            este.teclatUsuari
                            );

                    interval = setInterval(function () {
                        este.movimiento();
                    }, este.interval);
                },
                teclatUsuari: function (e) {
                    var este = Joc;
                    if (e.keyCode === 40) {
                        //abajo
                        este.puntuacio++;
                        este.movimiento();
                    } else if (e.keyCode === 38) {
                        //arriba
                        este.movimentHoritzontal("this.pecaVigent.rotarDreta();","this.pecaVigent.rotarEsquerra();");
                    } else if (e.keyCode === 37) {
                        //esquerra
                        este.movimentHoritzontal("this.pecaVigent.x--;","this.pecaVigent.x++;");
                    } else if (e.keyCode === 39) {
                        //dreta 
                            este.movimentHoritzontal("this.pecaVigent.x++;","this.pecaVigent.x--;");
                    }else if(e.keyCode ===32) {
                        //espacio
                        este.movimentHoritzontal("this.pecaVigent.rotarEsquerra();","this.pecaVigent.rotarDreta();");
                    }
                },
                sumaVeguades: function() {
                    var cont = 0;
                    for (var peca in this.nombreDeVegades) {
                        cont += this.nombreDeVegades[peca];
                    }
                    return cont;
                },
                intervalJoc: function () {
                    this.nivell++;
                    this.puntuacio+=20;
                    clearInterval(interval);
                                this.interval*=0.9;
                                interval = setInterval(function () {
                        Joc.movimiento();
                    }, Joc.interval);

                },
                hasPerdut:function(){
                    var filaAbaix=false;
                    var filaAmunt = false;
                    for(var i = 0; i<10; i++) {
                        if(this.espai[0][i]!==0 && this.espai[0][i]!="P") {
                            filaAmunt=true;
                        }
                        if(this.espai[24][i]!==0 && this.espai[24][i]!="P") {
                            filaAbaix=true;
                        }
                    }

                    if(filaAbaix && filaAmunt) {
                        alert("Has perdut :c");
                        var valorDeLaCookie = parseInt(document.cookie.substring(document.cookie.indexOf("=")+1));
                        if(valorDeLaCookie<this.puntuacio) {
                            document.cookie = "puntuacioMax="+parseInt(this.puntuacio);                            

                        }
                        clearInterval(interval);
                        
                        Joc.inicialitzarJoc();
                    }
                },
                cambiarPieza: function () {
                    switch (this.pecaVigent.color) {
                        case "groc":this.nombreDeVegades["o"]++;
                            break;
                        case "blau":this.nombreDeVegades["j"]++;
                            break;
                        case "lila":this.nombreDeVegades["i"]++;
                            break;
                        case "morat":this.nombreDeVegades["t"]++;
                            break;
                        case "taronga":this.nombreDeVegades["l"]++;
                            break;
                        case "roig":this.nombreDeVegades["z"]++;
                            break;
                        case "verd":this.nombreDeVegades["s"]++;
                            break;
                    }
                    this.pecaVigent = this.seguentPeca;
                    this.pecaVigent.x = 3;
                    this.pecaVigent.y = 0;
                    this.seguentPeca = new Pieza(GeneraPecaAleatoria(), 3, 0);

                    this.vaciarEspacio(1);
                },
                esborraTauler: function () {
                    var cont = 0;
                    var esborrar = false;
                    var fila;
                    for (var i = 0; i < this.espai.length; i++) {
                        for (var j = 0; j < this.espai[i].length; j++) {
                            if (this.espai[i][j] === 1) {
                                cont++;
                            }
                        }
                        if (cont !== 10) {
                            cont = 0;

                        } else {
                            esborrar = true;
                            fila = i;
                        }
                    }
                    if (esborrar) {
                        for (var i = fila; i >= 0; i--) {
                            if (i == 0) {
                                this.espai[0] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                            } else {
                                this.espai[i] = this.espai[i - 1];
                            }
                        }
                    }
                },
                movimiento: function () {
                    this.esborraTauler();
                    this.hasPerdut();
                    this.pecaVigent.y++;
                        if (this.colocarPiezaATauler() === false) {
                            this.vaciarEspacio(0);
                            this.pecaVigent.y--;
                            this.colocarPiezaATauler();
                            this.cambiarPieza();
                            this.pinta();
                            this.vaciarEspacio(0);
                            this.puntuacio+=10;
                            if(this.sumaVeguades()%10==0) {
                                this.intervalJoc();
                            }
                        }
                    this.pinta();
                    this.vaciarEspacio(0);

                },
                movimentHoritzontal:function(movimientoVerdadero, movimientoFalso){
                    this.esborraTauler();
                    eval(movimientoVerdadero);
                    if(this.colocarPiezaATauler() ==false) {
                            this.vaciarEspacio(0);
                            eval(movimientoFalso);
                            this.colocarPiezaATauler();
                            this.pinta();

                    }
                    this.pinta();
                    this.vaciarEspacio(0);
                },
                vaciarEspacio: function (parametro) {
                    for (var i = 0; i < this.espai.length; i++) {
                        for (var j = 0; j < this.espai[i].length; j++) {
                            if (this.espai[i][j] === "P") {
                                this.espai[i][j] = parametro;
                            }
                        }
                    }
                },
                pinta: function () {
                    var canvas = document.getElementById("espai");
                    var ctx = canvas.getContext("2d");
                    var img;
                    var print;

                    print = "Nivell: " + this.nivell + "<br>";
                    print += "Puntuació Actual: " + this.puntuacio + "<br>";
                    print += "Puntuació Màxima: " + this.puntuacioMax;
                    document.getElementById("joc").innerHTML = print;

                    this.seguentPeca.pintar();

                    for (var i = 0; i < this.espai.length; i++) {
                        for (var j = 0; j < this.espai[i].length; j++) {
                            if (this.espai[i][j] === "P") {
                                switch (this.pecaVigent.color) {
                                    case "groc":
                                        img = document.getElementById("piezaAmarilla");
                                        break;
                                    case "blau":
                                        img = document.getElementById("piezaAzul");
                                        break;
                                    case "lila":
                                        img = document.getElementById("piezaLila");
                                        break;
                                    case "morat":
                                        img = document.getElementById("piezaMorada");
                                        break;
                                    case "taronga":
                                        img = document.getElementById("piezaNaranja");
                                        break;
                                    case "roig":
                                        img = document.getElementById("piezaRoja");
                                        break;
                                    case "verd":
                                        img = document.getElementById("piezaVerde");
                                        break;
                                }
                            } else if (this.espai[i][j] === 1) {
                                img = document.getElementById("paret");
                            } else {
                                img = document.getElementById("empty");
                            }
                            ctx.drawImage(img, j * 24, i * 24, 24, 24);
                        }
                    }
                },
                colocarPiezaATauler: function () {
                    this.espaiBackUp = this.espai;
                    var top = 0;
                    var trobat = false;
                    for (var i = 0; i < this.pecaVigent.forma.length; i++) {
                        for (var j = 0; j < this.pecaVigent.forma[i].length; j++) {
                            if (this.pecaVigent.forma[i][j] === 1) { //si es una peça
                                if ((this.pecaVigent.y + top < 25) && (this.pecaVigent.x + j >= 0) && (this.pecaVigent.x + j <10)) {

                                        if (this.espai[this.pecaVigent.y + top][this.pecaVigent.x + j] != 0) {
                                            
                                            return false;
                                        }
                                        this.espai[this.pecaVigent.y + top][this.pecaVigent.x + j] = "P";
                                        trobat = true;
                                    
                                } else {
                                    return false;
                                }
                            }
                        }
                        if (trobat === true) {
                            top++;
                        }
                    }
                    return true;
                }
            };

            Joc.inicialitzarJoc();
        </script>
    </body>
</html>
